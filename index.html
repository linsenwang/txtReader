<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>txtReader</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.11/dist/katex.min.css">
    <link rel="icon" type="image/x-icon" href="web_icon/yanan.png" />
    <link rel="stylesheet" type="text/css" href="afdian_styles.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: auto;
            padding: 0;
        }

        /* for yanan */
        /* .folder_icon {
            height: 1em;
            width: 1em;
            margin: -0.15em 0.5em;
        } */

        /* for folder */
        .folder_icon {
            height: 1.2em;
            width: 1.2em;
            margin: -0.24em 0.5em;
        }

        .file-list {
            margin: 20px;
            padding: 10px;
        }

        .file-list ul {
            list-style-type: none;
            padding: 0;
            margin: 0;
        }

        .file-list li {
            margin: 10px 0;
            padding: 10px;
            display: flex;
            flex-direction: column; /* å‚ç›´æ’åˆ—å†…å®¹ */
            align-items: center; /* ç¡®ä¿å­å†…å®¹åœ¨å®¹å™¨ä¸­å±…ä¸­ */
            justify-content: center; /* å‚ç›´æ–¹å‘ä¹Ÿå±…ä¸­ */
            border-radius: 6px;
            text-align: center; /* è®©æ–‡æœ¬æ°´å¹³å±…ä¸­ */
        }

        .file-list a {
            text-decoration: none;
            color: #000;
            font-size: 16px;
            font-weight: bold;
            word-wrap: break-word; /* è‡ªåŠ¨æ¢è¡Œ */
            overflow-wrap: break-word;
            max-width: 100%; /* é™åˆ¶å®½åº¦ï¼Œç¡®ä¿é€‚åº”å®¹å™¨ */
            margin-bottom: 5px; /* æ·»åŠ ä¸æ—¶é—´çš„é—´è· */
            display: block; /* ä½¿é“¾æ¥å•ç‹¬å æ®ä¸€è¡Œå¹¶å±…ä¸­ */
        }

        .file-list a:hover {
            /* text-decoration: underline; */
            text-decoration: none;
            color: #0056b3; /* æ·±è‰²æ‚¬åœæ•ˆæœ */
        }

        .file-list a:visited {
        color: #888; /* è®¾ç½®è®¿é—®è¿‡çš„é“¾æ¥ä¸ºç´«è‰² */
        }

        .file-list .mtime {
            font-size: 12px;
            color: #555; /* ç°è‰²æ—¶é—´å­—ä½“ */
            white-space: nowrap; /* é¿å…æ—¶é—´å†…å®¹æ¢è¡Œ */
            display: block; /* ç¡®ä¿æ—¶é—´å•ç‹¬å æ®ä¸€è¡Œå¹¶å±…ä¸­ */
        }

        #toggleFoldersOnly {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 999;
            height: 40px;
            width: 40px;
            background-color: rgba(255, 255, 255, 0);
            border-radius: 40px;
            border: none;
            cursor: pointer;
        }


    @media (prefers-color-scheme: dark) {
        .file-list a {
            color: #fff;
        }

        .file-list .mtime {
            color: #aaa;
        }

        .file-list a:hover {
            /* text-decoration: underline; */
            text-decoration: none;
            color: #3388cc; /* æ·±è‰²æ‚¬åœæ•ˆæœ */
        }
    }
    </style>
</head>
<body>
    <button id="toggleFoldersOnly"><img src="web_icon/folder.svg" class='folder_icon'></button>
    <!-- æ–‡ä»¶åˆ—è¡¨ -->
    <div class="file-list" id="fileList">
        <!-- æ–‡ä»¶åˆ—è¡¨å°†æ’å…¥åœ¨è¿™é‡Œ -->
    </div>

    <!-- å¼•å…¥å¿…è¦çš„åº“ -->
    <script>
        document.addEventListener('keydown', (event) => {
            if (event.shiftKey && event.metaKey && event.code === 'KeyO') {
                window.location.href = './';
            }
        });

        // æœåŠ¡å™¨é…ç½®
        const SERVER_CONFIG = {
            progressOnly: false,
            remoteServerUrl: ''
        };

        // è·å–æœåŠ¡å™¨é…ç½®
        async function loadServerConfig() {
            try {
                const response = await fetch('/server-config');
                if (response.ok) {
                    const config = await response.json();
                    SERVER_CONFIG.progressOnly = config.progressOnly;
                    SERVER_CONFIG.remoteServerUrl = config.remoteServerUrl;
                    console.log('æœåŠ¡å™¨é…ç½®:', SERVER_CONFIG);
                }
            } catch (error) {
                console.log('è·å–æœåŠ¡å™¨é…ç½®å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤é…ç½®:', error);
            }
        }

        document.addEventListener('DOMContentLoaded', async function() {
            // å…ˆè·å–æœåŠ¡å™¨é…ç½®
            await loadServerConfig();

            // å¦‚æœæ˜¯ä»…è¿›åº¦æœåŠ¡å™¨æ¨¡å¼ï¼Œæ˜¾ç¤ºæç¤º
            if (SERVER_CONFIG.progressOnly) {
                const fileListDiv = document.getElementById('fileList');
                fileListDiv.innerHTML = `
                    <div style="text-align: center; padding: 50px; color: #666;">
                        <h2>ğŸ“š ä»…è¿›åº¦æœåŠ¡å™¨æ¨¡å¼</h2>
                        <p>æ­¤æœåŠ¡å™¨ä»…ç”¨äºä¿å­˜å’ŒåŒæ­¥é˜…è¯»è¿›åº¦ï¼Œä¸æä¾›å†…å®¹æœåŠ¡ã€‚</p>
                        ${SERVER_CONFIG.remoteServerUrl ? 
                            `<p>å†…å®¹æœåŠ¡è¯·è®¿é—®ï¼š<a href="${SERVER_CONFIG.remoteServerUrl}">${SERVER_CONFIG.remoteServerUrl}</a></p>` : 
                            ''}
                    </div>
                `;
                return;
            }

            // è·å–æ–‡ä»¶åˆ—è¡¨å¹¶æ˜¾ç¤º
            const urlParams = new URLSearchParams(window.location.search);
            const dir = urlParams.get('dir') || ''; // è·å– `dir` å‚æ•°ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™ä¸ºç©ºå­—ç¬¦ä¸²
            document.title = dir || 'txtReader';
            // fetch('/list-files')
            console.log('è¯·æ±‚çš„æ–‡ä»¶å¤¹ï¼š', dir); // è°ƒè¯•ä¿¡æ¯

            fetch(`/list-files?dir=${encodeURIComponent(dir)}`)
                .then(response => response.json())
                .then(files => {
                    console.log('æ¥æ”¶åˆ°çš„æ–‡ä»¶åˆ—è¡¨ï¼š', files); // è°ƒè¯•ä¿¡æ¯
                    const fileListDiv = document.getElementById('fileList');
                    let htmlContent = '<ul>';
                    files.forEach(file => {
                        const fileName = file.name;
                        const moFileName = file.name.replace(/_/g, ' ').replace(/--/g, ' ').replace(/.txt/g, ' ').replace(/â€”â€”/g, ' ');
                        const mtime = new Date(file.mtime).toLocaleString().replace(/,/g, ' '); // æ ¼å¼åŒ–æ—¥æœŸ
                        // åˆ›å»ºåŒ…å«æ–‡ä»¶åå’Œä¿®æ”¹æ—¶é—´çš„åˆ—è¡¨é¡¹
                        // htmlContent += `<li><a href="file.html?name=${encodeURIComponent(fileName)}">${moFileName}</a><span class="mtime">${mtime}</span></li>`;
                        if (fileName.endsWith('txt')) {
                            // å¦‚æœæ˜¯txtæ–‡ä»¶ï¼Œæ˜¾ç¤ºæ–‡ä»¶åç§°å’Œä¿®æ”¹æ—¶é—´
                            // htmlContent += `<li><a href="file.html?name=${encodeURIComponent(dir)+'/'+encodeURIComponent(fileName)}">${moFileName}</a><span class="mtime">${mtime}</span></li>`;
                            htmlContent += `<li class="file"><a href="file.html?name=${dir && dir !== '' ? encodeURIComponent(dir) + '/' : ''}${encodeURIComponent(fileName)}">${moFileName}</a><span class="mtime">${mtime}</span></li>`;
                        } else {
                            // å¦‚æœæ˜¯æ–‡ä»¶å¤¹ï¼Œæ˜¾ç¤ºæ–‡ä»¶å¤¹åç§°å¹¶æ·»åŠ é“¾æ¥åˆ°æ–‡ä»¶å¤¹é¡µé¢
                            htmlContent += `<li class="folder"><a href="index.html?dir=${encodeURIComponent(fileName)}"><img src="web_icon/folder.svg" class='folder_icon'>${moFileName}</a><span class="mtime">${mtime}</span></li>`;
                        }
                    });
                    htmlContent += '</ul>';
                    fileListDiv.innerHTML = htmlContent;
                })
                .catch(error => {
                    console.error('è·å–æ–‡ä»¶åˆ—è¡¨å‡ºé”™ï¼š', error);
                });
        });

    const button = document.getElementById('toggleFoldersOnly');
    let foldersOnly = false;

    function toggleFoldersOnly() {
        foldersOnly = !foldersOnly;
        const files = document.querySelectorAll('li.file');
        files.forEach(file => {
            file.style.display = foldersOnly ? 'none' : '';
        });
    }

    button.addEventListener('click', () => {
        toggleFoldersOnly();
    });

    document.addEventListener('keydown', function(event) {
        // Check if Shift + Command (Meta) + S is pressed
        if (event.shiftKey && event.metaKey && event.key.toLowerCase() === 'f') {
            event.preventDefault();
            toggleFoldersOnly();
        }
    });


    </script>
</body>
</html>
